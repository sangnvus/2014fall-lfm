@{
    ViewBag.Title = "Quản lí văn phòng";
    Layout = "~/Views/Shared/_BlankLayout.cshtml";
}

@section HeaderCss
{
    <link href="~/Content/css/jquery-ui-1.10.3.full.min.css" rel="stylesheet" type="text/css" />

    <link href="~/Content/css/datepicker.css" rel="stylesheet" type="text/css" />
    <link href="~/Content/css/jquery.gritter.css" rel="stylesheet" />
}

@section HeaderJs
{
    <script src="~/Content/js/bootbox.min.js" type="text/javascript"></script>
    <script src="~/Content/js/jquery-ui-1.10.3.full.min.js" type="text/javascript"></script>
    <script src="~/Content/js/jquery.numeric.js" type="text/javascript"></script>
    <script src="~/Content/js/jquery.dataTablesListOffice.js" type="text/javascript"></script>
    <script src="~/Content/js/jquery.dataTables.bootstrapListOffice.js" type="text/javascript"></script>
    <script src="~/Content/js/date-time/bootstrap-datepicker.min.js" type="text/javascript"></script>
    <script src="~/Content/js/jquery.autosize.min.js" type="text/javascript"></script>
    <script src="~/Content/js/jquery.gritter.min.js" type="text/javascript"></script>
    <script src="~/Content/js/jquery.validate.min.js"></script>
    <script src="~/Content/js/additional-methods.js"></script>
}

@section Breadcrumbs
{
    <div class="breadcrumbs" id="breadcrumbs">
        <script type="text/javascript">
            try { ace.settings.check('breadcrumbs', 'fixed') } catch (e) { }
        </script>
        <ul class="breadcrumb">
            <li class="active">
                <i class="icon-home home-icon"></i>
                <a href="/Home/Index">Trang chủ</a> | <span>Quản lí văn phòng</span>
            </li>
            <li>
                <span id="breadcrumbsMenu" style="font-weight: bold">Danh sách văn phòng</span>
            </li>
        </ul><!-- .breadcrumb -->
    </div>
}
<div id="StaffIdDiv" value="@Session["StaffId"]"></div>

<div id="bodyChangePass"></div>

@*List all office*@
<div class="table-responsive" id="divHidden">
    @if (@Session["StaffId"].ToString() == "1")
    {
        <a data-toggle="modal" href="#tblAddOffice">
            <button class="btn btn-primary" id="btnAdd">
                <i class="icon-plus"></i>
                Thêm văn phòng
            </button>
        </a>
    }

    <hr />
    <table id="tblOfffice" class="table table-striped table-bordered table-hover" width="100%">
        <thead>
            <tr>
                <th width="20%">Tên văn phòng</th>
                <th>Địa chỉ liên hệ</th>
                <th width="10%">Ðiện thoại</th>
                <th width="10%">Website</th>
                <th width="10%">Trạng thái</th>
                @if (Session["StaffId"].ToString() == "1")
                {
                    <th width="10%"></th>
                }
            </tr>
        </thead>
    </table>
</div>
<div id="tblAddOffice" class="modal fade" tabindex="-1">
    <div class="modal-dialog" style="width: 60%; min-width:600px; padding-top: 7%">
        <div class="modal-content">
            <div class="modal-header no-padding">
                <div class="table-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                        <span class="white">&times;</span>
                    </button>
                    Thêm văn phòng
                </div>
            </div>

            <form class="modal-body no-padding" id="addOfficeValidateForm">
                <div class="col-sm-6">
                    <div>
                        <br />
                        <div class="form-group">
                            <label>Tên văn phòng</label><span style="color: red"> *</span>
                            @*<input type="text" id="detailOffId" name="detailOffId" style="display: none" />*@
                            <div>
                                <textarea id="txtoffName" class=" form-control" name="txtoffName" style="resize: none" maxlength="100"></textarea>
                               
                                 @*<textarea  style="width: 100%" id="txtoffName" name="txtoffName"></textarea>*@
                            </div>
                            <div id="existOfficeName" style="display: none">
                                <span style="color: red">Tên văn phòng đã tồn tại!</span>
                            </div>

                        </div>
                        <div class="form-group">
                            <label>Nguời quản lí</label><span style="color: red"> *</span>
                            <div>
                                <input type="text" id="txtoffMana" name="txtoffMana" style="width: 100%" maxlength="50"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Số tài khoản</label>
                            <input type="text" id="txtoffBanknum" style="width: 100%" />
                        </div>
                        <div class="form-group">
                            <label>Fax</label>
                            <input type="text" id="txtoffFax" style="width: 100%" />
                        </div>
                        <div class="form-group">
                            <label>Email</label><span style="color: red"> *</span>
                            <div>
                                <input type="text" id="txtoffEmail" name="email" style="width: 100%" />
                            </div>
                        </div>


                    </div>
                </div>
                <div class="col-sm-6">
                    <div>
                        <br />
                        <div class="form-group">
                            <label>Ðịa chỉ văn phòng</label><span style="color: red"> *</span>
                            <div>
                                <textarea id="txtoffAdd" class=" form-control" name="txtoffAdd" style="resize: none"></textarea>
                                @*<textarea style="width: 100%" id="txtoffAdd" name="txtoffAdd"></textarea>*@
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Ðiện thoại</label><span style="color: red"> *</span>
                            <div class="form-group">
                                <div class="input-group">
                                    <span class="input-group-addon"> <i class="icon-phone"></i> </span>

                                    <input class="form-control input-mask-phone " type="text" id="txtoffPhone" name="txtoffPhone" style="width: 100%" />

                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Mã số thuế</label>
                            <input type="text" id="txtoffTax" maxlength="10" style="width: 100%" />
                        </div>
                        <div class="form-group">
                            <label>Ngân hàng</label>
                            <input type="text" id="txtoffBank" style="width: 100%" />
                        </div>
                        <div class="form-group">
                            <label>Website</label>
                            <input type="text" id="txtoffWeb" name="txtoffWeb" style="width: 100%" />
                        </div>
                    </div>
                </div>
                <div class="modal-footer no-margin-top">
                </div>
            </form>
            <div class="modal-footer no-margin-top">
                <button class="btn btn-warning pull-left" onclick="clearField()" id="btnClose" style="width: 125px">
                    <i class="icon-refresh"></i>
                    Làm trống
                </button>
                <button class="btn btn-success" type="button" data-bb-handler="confirm" id="btnAddNewCase" onclick="addOffice()">
                    <i class="icon-ok"></i>
                    Thêm mới
                </button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div>

<div id="tblOfficeDetail" class="modal fade" tabindex="-1">
    <div class="modal-dialog" style="width: 60%; min-width:600px; padding-top: 7%">
        <div class="modal-content">
            <div class="modal-header no-padding">
                <div class="table-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                        <span class="white">&times;</span>
                    </button>
                    Chi tiết văn phòng
                </div>
            </div>
            <form class="modal-body no-padding" id="updateOfficeValidateForm">
                <div class="col-sm-6">
                    <div>
                        <br />
                        <div class="form-group">
                            <label>Tên văn phòng</label><span style="color: red"> *</span>
                            <input type="text" id="detailOffId" name="detailOffId" style="display: none" />
                            <div>
                                <textarea id="detailOffName" class="editableInput form-control" name="txtoffName" style="resize: none"></textarea>
                                @*<textarea style="width: 100%" id="txtoffName" name="txtoffName" class="editableInput form-group" disabled></textarea>*@
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Nguời quản lí</label><span style="color: red"> *</span>
                            <div>
                                <input type="text" id="detailOffMana" name="txtoffMana" style="width: 100%" class="editableInput" disabled />
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Số tài khoản</label>
                            <input type="text" id="detailOffBanknum" style="width: 100%" class="editableInput" disabled />
                        </div>
                        <div class="form-group">
                            <label>Fax</label>
                            <input type="text" id="detailOffFax" style="width: 100%" class="editableInput" disabled />
                        </div>

                        <div class="form-group">
                            <label>Email</label><span style="color: red"> *</span>
                            <div>
                                <input type="text" id="detailOffEmail" name="email" style="width: 100%" class="editableInput" disabled />
                            </div>
                        </div>
                        @if (@Session["StaffId"].ToString() == "1")
                        {
                            <div class="form-group">
                                <i class="icon-hand-right green"></i>
                                <a href="#" style="" id="activeOffice" onclick="SetStatusOffice()"> </a>
                            </div>
                        }
                    </div>
                </div>
                <div class="col-sm-6">
                    <div>
                        <br />
                        <div class="form-group">
                            <label>Ðịa chỉ văn phòng</label><span style="color: red"> *</span>
                            <div>
                                <textarea id="detailOffAdd" class="editableInput form-control" name="txtoffAdd" style="resize: none"></textarea>
                                @*<textarea style="width: 100%" id="txtoffAdd" name="txtoffAdd" class="editableInput form-group" disabled></textarea>*@
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Ðiện thoại</label><span style="color: red"> *</span>
                            <div class="form-group">
                                <div class="input-group">
                                    <span class="input-group-addon"> <i class="icon-phone"></i> </span>

                                    <input class="form-control input-mask-phone editableInput " type="text" id="detailOffPhone" name="txtoffPhone" style="width: 100%" disabled />

                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Mã số thuế</label>
                            <input type="text" id="detailOffTax" maxlength="10" style="width: 100%" class="editableInput" disabled />
                        </div>
                        <div class="form-group">
                            <label>Ngân hàng</label>
                            <input type="text" id="detailOffBank" style="width: 100%" class="editableInput" disabled />
                        </div>
                        <div class="form-group">
                            <label>Website</label>
                            <input type="text" id="detailOffWeb" name="txtoffWeb" style="width: 100%" class="editableInput" disabled />
                        </div>
                    </div>
                </div>
                <div class="modal-footer no-margin-top">
                </div>
            </form>
            <div class="modal-footer no-margin-top">
                <button id="closeBtn" class="btn btn-grey pull-left" type="button" data-dismiss="modal">
                    <i class="icon-remove"></i>
                    Đóng
                </button>
                <button class="btn btn-success" onclick="updateOffice()" style="display:none" id="disablebutton">
                    <i class="icon-ok"></i>
                    Lưu chỉnh sửa
                </button>
                @if (Session["StaffId"].ToString() == "1")
                {
                    <button class="btn btn-primary" onclick="enablebutton()" id="enablebutton">
                        <i class="icon-edit"></i>
                        Chỉnh sửa
                    </button>
                }
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div>
<script type="text/javascript">
    $(document).ready(function () {
        getAllOfficeJson();

    });
    var allOffice = null;
    function getAllOfficeJson() {
        $.post("/Office/GetAllOfficeJson", {}, function (out) {
            var item = '<tbody>';
            allOffice = out;
            $.each(out, function (index, of) {
                item += '<tr>';
                item += '<td><a onClick="getOfficeByIndex(' + index + ')" data-toggle="modal" href="#tblOfficeDetail">' + of.OfficeName + '</a></td>';
                item += '<td>' + of.Address + '</td>';
                item += '<td>' + of.PhoneNumber + '</td>';
                item += '<td>' + of.Website + '</td>';
                if (of.Active) {
                    item += '<td><span class="label label-lg label-success arrowed">Đang hoạt động</span></td>';
                }
                else {
                    item += '<td><span class="label label-lg label-danger arrowed">Ngừng hoạt động</span></td>';
                }
                if ($("#StaffIdDiv").attr("value")=="1") item += '<td class="detailoffice visible-md visible-lg hidden-sm hidden-xs action-buttons "><center><a onClick="getOfficeByIndex(' + index + ')" class="view" title="Chi tiết" data-toggle="modal"href="#tblOfficeDetail" ' + index
                       + '"><i class="icon-zoom-in bigger-130"></i></a><a onClick="getOfficeByIndex(' + index + '),enablebutton() " class="green" title="Chỉnh sửa" data-toggle="modal" href="#tblOfficeDetail" data-id="' + index
                    + '"><i class="icon-pencil bigger-130"></i></a></center></td>';
                item += '</tr>';
            });
            item += '</tbody>';
            item = item.split("null").join("");

            $('#tblOfffice').html(item);

            if ($("#StaffIdDiv").attr("value") == "1") {
                $(".detailoffice").show();
                $("#tblOfffice").dataTable().fnDestroy();
                var oTable1 = $('#tblOfffice').dataTable({
                    "aoColumns": [
                       null, null, null, null, null, { "bSortable": false }
                    ]
                });
            }
            else {
             $(".detailoffice").hide();
            
                $("#tblOfffice").dataTable().fnDestroy();
                var oTable1 = $('#tblOfffice').dataTable({
                    "aoColumns": [
                       null, null, null, null, null
                    ]
                }); 
            }
            
            validateAddOffice('#addOfficeValidateForm');
            editFr = $('#tblAddOffice').val();
            // chỉ cho các giá trị nhập bên dưới là số
            $("#txtoffPhone", editFr).numeric({ decimal: false, negative: false });
            $("#txtoffTax", editFr).numeric({ decimal: false, negative: false });
        });
    }
    function addOffice() {
        if ($('#addOfficeValidateForm').valid()) {
            editFr = $('#tblAddOffice').val();
            var offName = $('#txtoffName', editFr).val();
            var offManager = $('#txtoffMana', editFr).val();
            var offTaxcode = $('#txtoffTax', editFr).val();
            var offEmail = $('#txtoffEmail', editFr).val();
            var offWebsite = $('#txtoffWeb', editFr).val();
            var offbankAccount = $('#txtoffBanknum', editFr).val();
            var offAdd = $('#txtoffAdd', editFr).val();
            var offPhone = $('#txtoffPhone', editFr).val();
            var offFax = $('#txtoffFax', editFr).val();
            var offBankName = $('#txtoffBank', editFr).val();
            $.post("/Office/AddOffice", {
                offName: offName, offManager: offManager, offTaxcode: offTaxcode, offEmail: offEmail,
                offWebsite: offWebsite, offbankAccount: offbankAccount, offAdd: offAdd, offPhone: offPhone,
                offFax: offFax, offbankName: offBankName
            }, function (result) {
                $('#existOfficeName').attr("style", "display: none");
                if (result == "successful") {
                    getAllOfficeJson();
                    $('.close').click();
                    clearField();
                    notification("Thêm văn phòng thành công!", "", 3000, "btn-primary center");
                } else if (result == 'error') {
                    $('.close').click();
                    notification("Thêm văn phòng thất bại!", 5000, "gritter-error center");
                } else if (result == "exist") {
                    $('#existOfficeName').attr("style", "display: block");
                }
            })
                    .error(function () {
                        $('#btnClose').click();
                        notification("Thêm văn phòng thất bại!", "Hãy kiểm tra lại kết nối database.", 5000, "gritter-error center");
                    });

        }
    }
    function getOfficeByIndex(index) {
        disablebutton();
        editFr = $('#tblOfficeDetail');
        $('#detailOffId', editFr).val(allOffice[index].OfficeId);
        $('#detailOffBank', editFr).val(allOffice[index].BankBranch);
        $('#detailOffName', editFr).val(allOffice[index].OfficeName);
        $('#detailOffAdd', editFr).val(allOffice[index].Address);
        $('#detailOffTax', editFr).val(allOffice[index].TaxCode);
        $('#detailOffFax', editFr).val(allOffice[index].Fax);
        $('#detailOffMana', editFr).val(allOffice[index].Manager);
        $('#detailOffEmail', editFr).val(allOffice[index].Email);
        $('#detailOffBanknum', editFr).val(allOffice[index].BankAccount);
        $('#detailOffWeb', editFr).val(allOffice[index].Website);
        $('#detailOffPhone', editFr).val(allOffice[index].PhoneNumber);
        // chỉ cho các giá trị nhập bên dưới là số
        $("#detailOffPhone", editFr).numeric({ decimal: false, negative: false });
        $("#detailOffTax", editFr).numeric({ decimal: false, negative: false });
        $('#activeOffice').text("Hoạt động lại").attr("style", "color:blue");
        if (allOffice[index].Active) {
            $('#activeOffice').text("Ngừng hoạt động").attr("style", "color:red");

        }
        $('#activeOffice').attr("onClick", "SetStatusOffice(" + allOffice[index].OfficeId + ")");
        validateAddOffice('#updateOfficeValidateForm');

    }
    function SetStatusOffice(id) {
        $(ace.click_event, function () {
            bootbox.confirm("Bạn có muốn thực hiện thao tác này?", function (result) {
                if (result) {
                    $.post("/Office/SetStatusOffice", { officeId: id }
                    , function (result) {
                        if (result == "active") {
                            getAllOfficeJson();
                            notification("Văn phòng đã hoạt động lại!", "", 3000, "btn-primary center");
                        } if (result == "inactive") {
                            getAllOfficeJson();
                            notification("Văn phòng đã ngừng hoạt động!", "", 3000, "btn-primary center");
                        }
                        else if (result == 'error') {

                            notification("Chỉnh hoạt động văn phòng thất bại!", "Hãy kiểm tra lại kết nối database.", 5000, "gritter-error center");
                        }
                    }).error(function () {
                        notification("Chỉnh hoạt động văn phòng thất bại!", "Có lỗi xảy ra trong quá trình xóa văn phòng.", 5000, "gritter-error center");
                    });
                    $("#closeBtn").click();
                }
            });
        });
    }
    function updateOffice() {
        if ($('#updateOfficeValidateForm').valid()) {
            editFr = $('#tblOfficeDetail');
            var offId = $('#detailOffId', editFr).val();
            var offName = $('#detailOffName', editFr).val();
            var offManager = $('#detailOffMana', editFr).val();
            var offTaxcode = $('#detailOffTax', editFr).val();
            var offEmail = $('#detailOffEmail', editFr).val();
            var offWebsite = $('#detailOffWeb', editFr).val();
            var offbankAccount = $('#detailOffBanknum', editFr).val();
            var offAdd = $('#detailOffAdd', editFr).val();
            var offPhone = $('#detailOffPhone', editFr).val();
            var offFax = $('#detailOffFax', editFr).val();
            var offBankBranch = $('#detailOffBank', editFr).val();
            disablebutton(); // CHỈNH sửa lần 2
            $.post("/Office/UpdateOffice", {
                offId: offId, offName: offName, offManager: offManager, offTaxcode: offTaxcode, offEmail: offEmail,
                offWebsite: offWebsite, offbankAccount: offbankAccount, offAdd: offAdd, offPhone: offPhone,
                offFax: offFax, offbankName: offBankBranch
            }, function (result) {
                if (result == "successful") {
                    getAllOfficeJson();

                    $('.close').click();
                    notification("Cập nhật chi tiết văn phòng thành công!", "", 3000, "btn-primary center");
                } else if (result == 'error') {
                    $('.close').click();
                    notification("Cập nhật chi tiết văn phòng thất bại!", 5000, "gritter-error center");
                }
            })
                    .error(function () {
                        $('#btnClose').click();
                        notification("Thêm văn phòng thất bại!", "Hãy kiểm tra lại kết nối database.", 5000, "gritter-error center");
                    });

        }
    }
    function disablebutton() {
        $('.editableInput').attr("disabled", "");
        //$('.inputDisable').attr("disabled", "disabled");
        $('#enablebutton').show();
        $('#disablebutton').hide();
    }
    function enablebutton() {
        $('.editableInput').removeAttr("readonly");
        $('.editableInput').removeAttr("disabled");
        $('#disablebutton').show();
        $('#enablebutton').hide();
    }
    function clearField() {
        editFr = $('#tblAddOffice');
        $('#txtoffName', editFr).val("");
        $('#txtoffMana', editFr).val("");
        $('#txtoffTax', editFr).val("");
        $('#txtoffEmail', editFr).val("");
        $('#txtoffWeb', editFr).val("");
        $('#txtoffBanknum', editFr).val("");
        $('#txtoffAdd', editFr).val("");
        $('#txtoffPhone', editFr).val("");
        $('#txtoffFax', editFr).val("");
        $('#txtoffBank', editFr).val("");
    }
    function validateAddOffice(validateform) {
        $(validateform).validate({
            errorElement: 'div',
            errorClass: 'help-block',
            focusInvalid: false,
            rules: {
                txtoffName: {
                    required: true
                },
                txtoffMana: {
                    required: true
                },
                email: {
                    required: true,
                    email: true
                },

                txtoffAdd: {
                    required: true
                },
                txtoffPhone: {
                    required: true
                }
            },
            messages: {
                txtoffName: {
                    required: "Nhập tên văn phòng!"
                },
                txtoffMana: {
                    required: "Nhập tên người quản lí văn phòng!",
                },
                email: {
                    required: "Hãy nhập Email của văn phòng!",
                },

                txtoffAdd: {
                    required: "Nhập địa chỉ văn phòng!",
                },
                txtoffPhone: {
                    required: "Nhập số điện thoại văn phòng!",
                }
            },
            highlight: function (e) {
                $(e).closest('.form-group').removeClass('has-info').addClass('has-error');
            },

            success: function (e) {
                $(e).closest('.form-group').removeClass('has-error').addClass('has-info');
                $(e).remove();
            },
            errorPlacement: function (error, element) {
                if (element.is(':checkbox') || element.is(':radio')) {
                    var controls = element.closest('div[class*="col-"]');
                    if (controls.find(':checkbox,:radio').length > 1) controls.append(error);
                    else error.insertAfter(element.nextAll('.lbl:eq(0)').eq(0));
                }
                else error.insertAfter(element.parent());
            }
        });
    }
</script>
<script type="text/javascript">
    jQuery(function ($) {
        var oTable1 = $('#tblOfffice').dataTable({
            "aoColumns": [
              null, null, null, null, { "bSortable": false }
            ]
        });

        $('.date-picker').datepicker({ autoclose: true }).next().on(ace.click_event, function () {
            $(this).prev().focus();
        });

        $('textarea[class*=autosize]').autosize({ append: "\n" });
    })
</script>






